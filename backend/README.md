# WorkCommunities Backend — Mock Data Overview

This document describes the mock data generated by the scripts in `app/scripts` and how to run them via Docker.

**API Overview**
- Auth: Bearer JWT in `Authorization: Bearer <token>`.
- Framework: FastAPI. All routes are mounted under the root router defined in `app/presentation/api/router.py`.
- Layers:
  - Domain entities and protocols: `app/domain`.
  - Repositories (DB access, SQLAlchemy): `app/infrastructure/repos`.
  - Use cases (business logic): `app/usecases`.
  - API endpoints and schemas: `app/presentation/api`, `app/presentation/schemas`.

**HTTP E2E Test**
- Script: `app/scripts/e2e_http_test.py`
- Runs a live sanity check against a running instance:
  - Creates a student user via OTP, updates profile
  - Lists and follows a community, fetches posts
  - Lists upcoming events and joins one (if available)
  - Checks feed from followed communities
- Run locally against remote service:
  - `python -m app.scripts.e2e_http_test --base-url http://91.197.99.176:8000`
  - Options: `--phone +7999XXXXXXX`, `--code 11111`, `--verbose`

**Company Flow Script**
- Script: `app/scripts/e2e_company_flow.py`
- Performs authenticated company flow via HTTP:
  - Signs up a company and obtains a token
  - Creates a community under this company
  - Uploads media and creates a post with media
  - Creates a story for the company with uploaded media
  - Creates an event in the created community
  - Sets a community logo via `PATCH /communities/{id}`
- Run:
  - `python -m app.scripts.e2e_company_flow --base-url http://91.197.99.176:8000`
  - Options: `--email`, `--password`, `--company-name`, `--verbose`

Key endpoints by area (short list)
- Communities (`/communities`)
  - `GET /communities/` — list all non-archived communities.
  - `GET /communities/by-company/{company_id}` — communities for a company.
  - `GET /communities/joinable` — communities user can join (not a member of), requires auth.
  - `GET /communities/mine` — role-aware list, requires auth:
    - For `student` users: returns communities the user follows.
    - For `company` users: returns communities that belong to the user’s company.
  - `POST /communities/` — create community (auth `company`), company is taken from the session user.
  - `POST /communities/{community_id}/follow` and `DELETE /communities/{community_id}/follow` — follow/unfollow.
  - `GET /communities/{community_id}/posts` — posts in a community.
  - Community logo: `logo_media_id` (FK to media) available on Community. Set via create or `PATCH /communities/{id}`.
- Companies (`/companies`)
  - `GET /companies/` — list companies (includes `logo_media_id`).
  - `GET /companies/me/followed` — companies the current user follows.
  - `POST /companies/{company_id}/follow` and `DELETE /companies/{company_id}/follow` — follow/unfollow a company.
  - `PATCH /companies/me` — update current company (auth `company`). Supports `name`, `description`, `logo_media_id`.
    - To set a logo: upload media first (see Media), then pass returned `id` as `logo_media_id`.
- Profiles (`/profiles`)
  - `GET /profiles/me` — get or create profile for current user.
  - `PATCH /profiles/me` — update profile. Fields: `full_name`, `portfolio_url`, `description`, `skill_uids`, `status_uids`.
    - Note: city and interests were removed from API; they are ignored if present in DB.
- Media (`/media`)
  - `POST /media/upload` — upload a file. Returns `{ id, kind, mime, ext, size, url }`.
  - `GET /media/{id}` — serve stored file.
- Events (`/events`)
  - `GET /events/upcoming` — upcoming events for current user based on memberships and follows.
  - `POST /events/` — create event (auth `company`).

Data model (selected)
- User: minimal auth context with `id`, `role`, `phone`/`email`.
- Company: `id`, `name`, `description`, `logo_media_id` (FK to media), optional `owner_user_id`.
- Community: belongs to a company, has `name`, `description`, `tags`, `telegram_url`, `is_archived`.
- Follow: user follows a community. CompanyFollow: user follows a company.
- Membership: user is a member of a community with `role`.
- Post, Media, Story, Event: content types used across feeds and community pages.
- Profile: user profile with `full_name`, `portfolio_url`, `description`, relations to `skills` and `statuses`.

Auth and roles
- JWT parsed in dependency `get_current_user`; roles enforced via `role_required(...)`.
- Current company is resolved via `get_current_company` (company owned by the user with role `company`).

## Scripts
- `app/scripts/clear_db.py`
  - Drops all tables and recreates an empty schema.
  - Run: `docker compose exec api python -m app.scripts.clear_db`
- `app/scripts/seed_reference_data.py`
  - Seeds reference dictionaries (statuses, spheres, skills).
  - Run: `docker compose exec api python -m app.scripts.seed_reference_data`
- `app/scripts/generate_mock_data.py`
  - Generates users, companies, communities, and posts (does not touch reference dictionaries).
  - Run: `docker compose exec api python -m app.scripts.generate_mock_data`
- `app/scripts/migrate_add_company_logo.py`
  - Adds missing column `companies.logo_media_id` to keep old DBs compatible after adding company logo feature.
  - Idempotent: safe to run multiple times.
  - Run: `docker compose exec api python -m app.scripts.migrate_add_company_logo`
- `app/scripts/migrate_add_community_logo.py`
  - Adds missing column `communities.logo_media_id` to keep old DBs compatible after adding community logo feature.
  - Idempotent: safe to run multiple times.
  - Run: `docker compose exec api python -m app.scripts.migrate_add_community_logo`
- `app/scripts/set_default_logos.py`
  - Sets `logo_media_id` for all companies and communities. By default affects only rows where it is NULL; use `--force` to overwrite.
  - Run: `docker compose exec api python -m app.scripts.set_default_logos --logo-id e0bee682aa83422db1463cfbcb4acd73`

Recommended flow in dev:
1) Clear DB (destructive). 2) Seed reference data. 3) Generate mock data.

## Mock Data Details
The generator creates deterministic data with predictable names/keys to simplify testing.

### Users
- Count: 5 student users.
- Role: `student`.
- Phones: `+7999000XXXX` for `XXXX = 0001..0005`.
- Emails: not set (None). Passwords: not set (None).

### Companies
- Count: 3 companies.
- Names: `Mock Company 01`, `Mock Company 02`, `Mock Company 03`.
- Descriptions: `Описание компании <Name>`.

### Communities
- Count: 6 communities (2 per company).
- Names: `Community 11`, `Community 12`, `Community 21`, `Community 22`, `Community 31`, `Community 32`.
- Description: `Описание для <Community Name>`.
- Tags: comma-separated string with three parts: `mock,test,<NN>` where `<NN>` matches the community suffix (`11`, `12`, ...).
- Telegram URL: None.
- Archived: `False`.

### Posts
- Count: 18 posts (3 per community).
- Title pattern: `Пост <NN>` where `<NN>` is `11..13` for the first community, `21..23` for the second, etc.
- Body: two lines joined with a newline, to cover multiline content.
- Featured: `True` when the internal post index is divisible by 3 (i.e., every third post), else `False`.
- Author: one of the 5 student users, selected in a rotating manner per community.
- Created at: current UTC time at insert.

## How to Verify via API
- Companies: `GET /companies/` — returns all companies.
- Communities: `GET /communities/` — returns all non-archived communities.
- Skills (reference): `GET /reference/skills` — returns all skills (if seeded).
- Featured posts (per user):
  - `GET /content/users/{user_id}/posts/featured` — featured posts for an arbitrary user.
  - `GET /content/me/posts/featured` — featured posts for the current user (requires auth).

## Notes
- The generator does not create memberships, follows, events, or media; these can be added later if needed.
- If the DB schema was changed recently, and you already have tables, consider running the clear script (dev only) or use migrations.
  - For the company logo feature, run the lightweight migration script above to add `logo_media_id` into existing DBs.
